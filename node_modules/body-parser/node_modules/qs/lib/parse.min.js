var Utils=require("./utils"),internals={delimiter:"&",depth:5,arrayLimit:20,parameterLimit:1e3};internals.parseValues=function(a,b){for(var c={},d=a.split(b.delimiter,b.parameterLimit===1/0?void 0:b.parameterLimit),e=0,f=d.length;f>e;++e){var g=d[e],h=-1===g.indexOf("]=")?g.indexOf("="):g.indexOf("]=")+1;if(-1===h)c[Utils.decode(g)]="";else{var i=Utils.decode(g.slice(0,h)),j=Utils.decode(g.slice(h+1));if(Object.prototype.hasOwnProperty(i))continue;c.hasOwnProperty(i)?c[i]=[].concat(c[i]).concat(j):c[i]=j}}return c},internals.parseObject=function(a,b,c){if(!a.length)return b;var d=a.shift(),e={};if("[]"===d)e=[],e=e.concat(internals.parseObject(a,b,c));else{var f="["===d[0]&&"]"===d[d.length-1]?d.slice(1,d.length-1):d,g=parseInt(f,10),h=""+g;!isNaN(g)&&d!==f&&h===f&&g>=0&&g<=c.arrayLimit?(e=[],e[g]=internals.parseObject(a,b,c)):e[f]=internals.parseObject(a,b,c)}return e},internals.parseKeys=function(a,b,c){if(a){var d=/^([^\[\]]*)/,e=/(\[[^\[\]]*\])/g,f=d.exec(a);if(!Object.prototype.hasOwnProperty(f[1])){var g=[];f[1]&&g.push(f[1]);for(var h=0;null!==(f=e.exec(a))&&h<c.depth;)++h,Object.prototype.hasOwnProperty(f[1].replace(/\[|\]/g,""))||g.push(f[1]);return f&&g.push("["+a.slice(f.index)+"]"),internals.parseObject(g,b,c)}}},module.exports=function(a,b){if(""===a||null===a||"undefined"==typeof a)return{};b=b||{},b.delimiter="string"==typeof b.delimiter||Utils.isRegExp(b.delimiter)?b.delimiter:internals.delimiter,b.depth="number"==typeof b.depth?b.depth:internals.depth,b.arrayLimit="number"==typeof b.arrayLimit?b.arrayLimit:internals.arrayLimit,b.parameterLimit="number"==typeof b.parameterLimit?b.parameterLimit:internals.parameterLimit;for(var c="string"==typeof a?internals.parseValues(a,b):a,d={},e=Object.keys(c),f=0,g=e.length;g>f;++f){var h=e[f],i=internals.parseKeys(h,c[h],b);d=Utils.merge(d,i)}return Utils.compact(d)};