function getDecoder(a){if(!a)return null;try{return iconv.getCodec(a).decoder()}catch(b){var c=makeError("specified encoding unsupported","encoding.unsupported");throw c.status=c.statusCode=415,c.encoding=a,c}}function halt(a){unpipe(a),"function"==typeof a.pause&&a.pause()}function makeError(a,b){var c=new Error;return c.message=a,Object.defineProperty(c,"type",{value:b,enumerable:!0,writable:!0,configurable:!0}),c}function unpipe(a){if("function"==typeof a.unpipe)return void a.unpipe();for(var b,c=a.listeners("close"),d=0;d<c.length;d++)b=c[d],("cleanup"===b.name||"onclose"===b.name)&&b.call(a)}var bytes=require("bytes"),iconv=require("iconv-lite");module.exports=function(a,b,c){function d(a){c=a}function e(){var b=makeError("request aborted","request.aborted");b.code="ECONNABORTED",b.status=400,b.received=o,b.length=b.expected=k,h(),halt(a),c(b)}function f(b){if(o+=b.length,n?p+=n.write(b):p.push(b),null!==j&&o>j){var d=makeError("request entity too large","entity.too.large");d.status=d.statusCode=413,d.received=o,d.limit=j,h(),halt(a),c(d)}}function g(b){if(b)h(),halt(a),c(b);else if(null!==k&&o!==k)b=makeError("request size did not match content length","request.size.invalid"),b.status=b.statusCode=400,b.received=o,b.length=b.expected=k,h(),c(b);else{var d=n?p+(n.end()||""):Buffer.concat(p);h(),c(null,d)}}function h(){o=p=null,a.removeListener("aborted",e),a.removeListener("data",f),a.removeListener("end",g),a.removeListener("error",g),a.removeListener("close",h)}(b===!0||"string"==typeof b)&&(b={encoding:b}),b=b||{},"function"==typeof b&&(c=b,b={});var i=b.encoding!==!0?b.encoding:"utf-8",j=null;"number"==typeof b.limit&&(j=b.limit),"string"==typeof b.limit&&(j=bytes(b.limit));var k=null;if(null==b.length||isNaN(b.length)||(k=parseInt(b.length,10)),null!==j&&null!==k&&k>j){var l=makeError("request entity too large","entity.too.large");return l.status=l.statusCode=413,l.length=l.expected=k,l.limit=j,h(),halt(a),process.nextTick(function(){c(l)}),d}var m=a._readableState;if(a._decoder||m&&(m.encoding||m.decoder)){var l=makeError("stream encoding should not be set","stream.encoding.set");return l.status=l.statusCode=500,h(),halt(a),process.nextTick(function(){c(l)}),d}var n,o=0;try{n=getDecoder(i)}catch(l){return h(),halt(a),process.nextTick(function(){c(l)}),d}var p=n?"":[];return a.on("aborted",e),a.on("data",f),a.once("end",g),a.once("error",g),a.once("close",h),d};