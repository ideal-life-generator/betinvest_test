function logerror(a){"test"!==this.get("env")&&console.error(a.stack||a.toString())}var finalhandler=require("finalhandler"),flatten=require("./utils").flatten,Router=require("./router"),methods=require("methods"),middleware=require("./middleware/init"),query=require("./middleware/query"),debug=require("debug")("express:application"),View=require("./view"),http=require("http"),compileETag=require("./utils").compileETag,compileQueryParser=require("./utils").compileQueryParser,compileTrust=require("./utils").compileTrust,deprecate=require("depd")("express"),merge=require("utils-merge"),resolve=require("path").resolve,slice=Array.prototype.slice,app=exports=module.exports={},trustProxyDefaultSymbol="@@symbol:trust_proxy_default";app.init=function(){this.cache={},this.settings={},this.engines={},this.defaultConfiguration()},app.defaultConfiguration=function(){this.enable("x-powered-by"),this.set("etag","weak");var a=process.env.NODE_ENV||"development";this.set("env",a),this.set("query parser","extended"),this.set("subdomain offset",2),this.set("trust proxy",!1),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!0}),debug("booting in %s mode",a),this.on("mount",function(a){this.settings[trustProxyDefaultSymbol]===!0&&"function"==typeof a.settings["trust proxy fn"]&&(delete this.settings["trust proxy"],delete this.settings["trust proxy fn"]),this.request.__proto__=a.request,this.response.__proto__=a.response,this.engines.__proto__=a.engines,this.settings.__proto__=a.settings}),this.locals=Object.create(null),this.mountpath="/",this.locals.settings=this.settings,this.set("view",View),this.set("views",resolve("views")),this.set("jsonp callback name","callback"),"production"===a&&this.enable("view cache"),Object.defineProperty(this,"router",{get:function(){throw new Error("'app.router' is deprecated!\nPlease see the 3.x to 4.x migration guide for details on how to update your app.")}})},app.lazyrouter=function(){this._router||(this._router=new Router({caseSensitive:this.enabled("case sensitive routing"),strict:this.enabled("strict routing")}),this._router.use(query(this.get("query parser fn"))),this._router.use(middleware.init(this)))},app.handle=function(a,b,c){var d=this._router;return c=c||finalhandler(a,b,{env:this.get("env"),onerror:logerror.bind(this)}),d?void d.handle(a,b,c):(debug("no routes defined on app"),void c())},app.use=function(a){var b=0,c="/";if("function"!=typeof a){for(var d=a;Array.isArray(d)&&0!==d.length;)d=d[0];"function"!=typeof d&&(b=1,c=a)}var e=flatten(slice.call(arguments,b));if(0===e.length)throw new TypeError("app.use() requires middleware functions");this.lazyrouter();var f=this._router;return e.forEach(function(a){return a&&a.handle&&a.set?(debug(".use app under %s",c),a.mountpath=c,a.parent=this,f.use(c,function(b,c,d){var e=b.app;a.handle(b,c,function(a){b.__proto__=e.request,c.__proto__=e.response,d(a)})}),void a.emit("mount",this)):f.use(c,a)},this),this},app.route=function(a){return this.lazyrouter(),this._router.route(a)},app.engine=function(a,b){if("function"!=typeof b)throw new Error("callback function required");return"."!=a[0]&&(a="."+a),this.engines[a]=b,this},app.param=function(a,b){return this.lazyrouter(),Array.isArray(a)?(a.forEach(function(a){this.param(a,b)},this),this):(this._router.param(a,b),this)},app.set=function(a,b){if(1===arguments.length)return this.settings[a];switch(this.settings[a]=b,a){case"etag":debug("compile etag %s",b),this.set("etag fn",compileETag(b));break;case"query parser":debug("compile query parser %s",b),this.set("query parser fn",compileQueryParser(b));break;case"trust proxy":debug("compile trust proxy %s",b),this.set("trust proxy fn",compileTrust(b)),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!1})}return this},app.path=function(){return this.parent?this.parent.path()+this.mountpath:""},app.enabled=function(a){return!!this.set(a)},app.disabled=function(a){return!this.set(a)},app.enable=function(a){return this.set(a,!0)},app.disable=function(a){return this.set(a,!1)},methods.forEach(function(a){app[a]=function(b){if("get"==a&&1==arguments.length)return this.set(b);this.lazyrouter();var c=this._router.route(b);return c[a].apply(c,slice.call(arguments,1)),this}}),app.all=function(a){this.lazyrouter();var b=this._router.route(a),c=slice.call(arguments,1);return methods.forEach(function(a){b[a].apply(b,c)}),this},app.del=deprecate["function"](app["delete"],"app.del: Use app.delete instead"),app.render=function(a,b,c){var d,e={},f=this.cache,g=this.engines;if("function"==typeof b&&(c=b,b={}),merge(e,this.locals),b._locals&&merge(e,b._locals),merge(e,b),e.cache=null==e.cache?this.enabled("view cache"):e.cache,e.cache&&(d=f[a]),!d){if(d=new(this.get("view"))(a,{defaultEngine:this.get("view engine"),root:this.get("views"),engines:g}),!d.path){var h=Array.isArray(d.root)&&d.root.length>1?'directories "'+d.root.slice(0,-1).join('", "')+'" or "'+d.root[d.root.length-1]+'"':'directory "'+d.root+'"',i=new Error('Failed to lookup view "'+a+'" in views '+h);return i.view=d,c(i)}e.cache&&(f[a]=d)}try{d.render(e,c)}catch(i){c(i)}},app.listen=function(){var a=http.createServer(this);return a.listen.apply(a,arguments)};