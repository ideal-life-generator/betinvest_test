function sendfile(a,b,c,d){function e(){if(!m){m=!0;var a=new Error("Request aborted");a.code="ECONNABORTED",d(a)}}function f(){if(!m){m=!0;var a=new Error("EISDIR, read");a.code="EISDIR",d(a)}}function g(a){m||(m=!0,d(a))}function h(){m||(m=!0,d())}function i(){l=!1}function j(a){return a&&"ECONNRESET"===a.code?e():a?g(a):void(m||setImmediate(function(){return l===!1||m?void(m||(m=!0,d())):void e()}))}function k(){l=!0}var l,m=!1;b.on("directory",f),b.on("end",h),b.on("error",g),b.on("file",i),b.on("stream",k),onFinished(a,j),c.headers&&b.on("headers",function(a){for(var b=c.headers,d=Object.keys(b),e=0;e<d.length;e++){var f=d[e];a.setHeader(f,b[f])}}),b.pipe(a)}var contentDisposition=require("content-disposition"),deprecate=require("depd")("express"),escapeHtml=require("escape-html"),http=require("http"),isAbsolute=require("./utils").isAbsolute,onFinished=require("on-finished"),path=require("path"),merge=require("utils-merge"),sign=require("cookie-signature").sign,normalizeType=require("./utils").normalizeType,normalizeTypes=require("./utils").normalizeTypes,setCharset=require("./utils").setCharset,statusCodes=http.STATUS_CODES,cookie=require("cookie"),send=require("send"),extname=path.extname,mime=send.mime,resolve=path.resolve,vary=require("vary"),res=module.exports={__proto__:http.ServerResponse.prototype};res.status=function(a){return this.statusCode=a,this},res.links=function(a){var b=this.get("Link")||"";return b&&(b+=", "),this.set("Link",b+Object.keys(a).map(function(b){return"<"+a[b]+'>; rel="'+b+'"'}).join(", "))},res.send=function(a){var b,c,d,e=a,f=this.req,g=this.app;switch(2===arguments.length&&("number"!=typeof arguments[0]&&"number"==typeof arguments[1]?(deprecate("res.send(body, status): Use res.status(status).send(body) instead"),this.statusCode=arguments[1]):(deprecate("res.send(status, body): Use res.status(status).send(body) instead"),this.statusCode=arguments[0],e=arguments[1])),"number"==typeof e&&1===arguments.length&&(this.get("Content-Type")||this.type("txt"),deprecate("res.send(status): Use res.sendStatus(status) instead"),this.statusCode=e,e=http.STATUS_CODES[e]),typeof e){case"string":this.get("Content-Type")||this.type("html");break;case"boolean":case"number":case"object":if(null===e)e="";else{if(!Buffer.isBuffer(e))return this.json(e);this.get("Content-Type")||this.type("bin")}}"string"==typeof e&&(b="utf8",d=this.get("Content-Type"),"string"==typeof d&&this.set("Content-Type",setCharset(d,"utf-8"))),void 0!==e&&(Buffer.isBuffer(e)||(e=new Buffer(e,b),b=void 0),c=e.length,this.set("Content-Length",c));var h,i=void 0!==c&&g.get("etag fn");return"function"!=typeof i||this.get("ETag")||(h=i(e,b))&&this.set("ETag",h),f.fresh&&(this.statusCode=304),(204==this.statusCode||304==this.statusCode)&&(this.removeHeader("Content-Type"),this.removeHeader("Content-Length"),this.removeHeader("Transfer-Encoding"),e=""),"HEAD"===f.method?this.end():this.end(e,b),this},res.json=function(a){var b=a;2===arguments.length&&("number"==typeof arguments[1]?(deprecate("res.json(obj, status): Use res.status(status).json(obj) instead"),this.statusCode=arguments[1]):(deprecate("res.json(status, obj): Use res.status(status).json(obj) instead"),this.statusCode=arguments[0],b=arguments[1]));var c=this.app,d=c.get("json replacer"),e=c.get("json spaces"),f=JSON.stringify(b,d,e);return this.get("Content-Type")||this.set("Content-Type","application/json"),this.send(f)},res.jsonp=function(a){var b=a;2===arguments.length&&("number"==typeof arguments[1]?(deprecate("res.jsonp(obj, status): Use res.status(status).json(obj) instead"),this.statusCode=arguments[1]):(deprecate("res.jsonp(status, obj): Use res.status(status).jsonp(obj) instead"),this.statusCode=arguments[0],b=arguments[1]));var c=this.app,d=c.get("json replacer"),e=c.get("json spaces"),f=JSON.stringify(b,d,e),g=this.req.query[c.get("jsonp callback name")];return this.get("Content-Type")||(this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","application/json")),Array.isArray(g)&&(g=g[0]),"string"==typeof g&&0!==g.length&&(this.charset="utf-8",this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","text/javascript"),g=g.replace(/[^\[\]\w$.]/g,""),f=f.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),f="/**/ typeof "+g+" === 'function' && "+g+"("+f+");"),this.send(f)},res.sendStatus=function(a){var b=http.STATUS_CODES[a]||String(a);return this.statusCode=a,this.type("txt"),this.send(b)},res.sendFile=function(a,b,c){var d=this.req,e=this,f=d.next;if(!a)throw new TypeError("path argument is required to res.sendFile");if("function"==typeof b&&(c=b,b={}),b=b||{},!b.root&&!isAbsolute(a))throw new TypeError("path must be absolute or specify root to res.sendFile");var g=encodeURI(a),h=send(d,g,b);sendfile(e,h,b,function(a){return c?c(a):a&&"EISDIR"===a.code?f():void(a&&"ECONNABORTED"!==a.code&&"write"!==a.syscall&&f(a))})},res.sendfile=function(a,b,c){var d=this.req,e=this,f=d.next;"function"==typeof b&&(c=b,b={}),b=b||{};var g=send(d,a,b);sendfile(e,g,b,function(a){return c?c(a):a&&"EISDIR"===a.code?f():void(a&&"ECONNABORT"!==a.code&&"write"!==a.syscall&&f(a))})},res.sendfile=deprecate["function"](res.sendfile,"res.sendfile: Use res.sendFile instead"),res.download=function(a,b,c){"function"==typeof b&&(c=b,b=null),b=b||a;var d={"Content-Disposition":contentDisposition(b)},e=resolve(a);return this.sendFile(e,{headers:d},c)},res.contentType=res.type=function(a){return this.set("Content-Type",~a.indexOf("/")?a:mime.lookup(a))},res.format=function(a){var b=this.req,c=b.next,d=a["default"];d&&delete a["default"];var e=Object.keys(a),f=b.accepts(e);if(this.vary("Accept"),f)this.set("Content-Type",normalizeType(f).value),a[f](b,this,c);else if(d)d();else{var g=new Error("Not Acceptable");g.status=406,g.types=normalizeTypes(e).map(function(a){return a.value}),c(g)}return this},res.attachment=function(a){return a&&this.type(extname(a)),this.set("Content-Disposition",contentDisposition(a)),this},res.append=function(a,b){var c=this.get(a),d=b;return c&&(d=Array.isArray(c)?c.concat(b):Array.isArray(b)?[c].concat(b):[c,b]),this.set(a,d)},res.set=res.header=function(a,b){if(2===arguments.length){if(b=Array.isArray(b)?b.map(String):String(b),"content-type"==a.toLowerCase()&&!/;\s*charset\s*=/.test(b)){var c=mime.charsets.lookup(b.split(";")[0]);c&&(b+="; charset="+c.toLowerCase())}this.setHeader(a,b)}else for(var d in a)this.set(d,a[d]);return this},res.get=function(a){return this.getHeader(a)},res.clearCookie=function(a,b){var c={expires:new Date(1),path:"/"};return this.cookie(a,"",b?merge(c,b):c)},res.cookie=function(a,b,c){c=merge({},c);var d=this.req.secret,e=c.signed;if(e&&!d)throw new Error('cookieParser("secret") required for signed cookies');"number"==typeof b&&(b=b.toString()),"object"==typeof b&&(b="j:"+JSON.stringify(b)),e&&(b="s:"+sign(b,d)),"maxAge"in c&&(c.expires=new Date(Date.now()+c.maxAge),c.maxAge/=1e3),null==c.path&&(c.path="/");var f=cookie.serialize(a,String(b),c),g=this.get("Set-Cookie");return g&&(f=Array.isArray(g)?g.concat(f):[g,f]),this.set("Set-Cookie",f),this},res.location=function(a){var b=this.req;return"back"==a&&(a=b.get("Referrer")||"/"),this.set("Location",a),this},res.redirect=function(a){var b,c=a,d=302;2===arguments.length&&("number"==typeof arguments[0]?(d=arguments[0],c=arguments[1]):(deprecate("res.redirect(url, status): Use res.redirect(status, url) instead"),d=arguments[1])),this.location(c),c=this.get("Location"),this.format({text:function(){b=statusCodes[d]+". Redirecting to "+encodeURI(c)},html:function(){var a=escapeHtml(c);b="<p>"+statusCodes[d]+'. Redirecting to <a href="'+a+'">'+a+"</a></p>"},"default":function(){b=""}}),this.statusCode=d,this.set("Content-Length",Buffer.byteLength(b)),"HEAD"===this.req.method?this.end():this.end(b)},res.vary=function(a){return!a||Array.isArray(a)&&!a.length?(deprecate("res.vary(): Provide a field name"),this):(vary(this,a),this)},res.render=function(a,b,c){b=b||{};var d=this,e=this.req,f=e.app;"function"==typeof b&&(c=b,b={}),b._locals=d.locals,c=c||function(a,b){return a?e.next(a):void d.send(b)},f.render(a,b,c)};