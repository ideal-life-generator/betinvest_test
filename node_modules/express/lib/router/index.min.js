function appendMethods(a,b){for(var c=0;c<b.length;c++){var d=b[c];-1===a.indexOf(d)&&a.push(d)}}function getPathname(a){try{return parseUrl(a).pathname}catch(b){return void 0}}function gettype(a){var b=typeof a;return"object"!==b?b:toString.call(a).replace(objectRegExp,"$1")}function matchLayer(a,b){try{return a.match(b)}catch(c){return c}}function mergeParams(a,b){if("object"!=typeof b||!b)return a;var c=mixin({},b);if(!(0 in a&&0 in b))return mixin(c,a);for(var d=0,e=0;d===e||e in b;)d in a&&d++,e in b&&e++;for(d--;d>=0;d--)a[d+e]=a[d],e>d&&delete a[d];return mixin(b,a)}function restore(a,b){for(var c=new Array(arguments.length-2),d=new Array(arguments.length-2),e=0;e<c.length;e++)c[e]=arguments[e+2],d[e]=b[c[e]];return function(e){for(var f=0;f<c.length;f++)b[c[f]]=d[f];return a.apply(this,arguments)}}function sendOptionsResponse(a,b,c){try{var d=b.join(",");a.set("Allow",d),a.send(d)}catch(e){c(e)}}function wrap(a,b){return function(){var c=new Array(arguments.length+1);c[0]=a;for(var d=0,e=arguments.length;e>d;d++)c[d+1]=arguments[d];b.apply(this,c)}}var Route=require("./route"),Layer=require("./layer"),methods=require("methods"),mixin=require("utils-merge"),debug=require("debug")("express:router"),deprecate=require("depd")("express"),parseUrl=require("parseurl"),utils=require("../utils"),objectRegExp=/^\[object (\S+)\]$/,slice=Array.prototype.slice,toString=Object.prototype.toString,proto=module.exports=function(a){function b(a,c,d){b.handle(a,c,d)}return a=a||{},b.__proto__=proto,b.params={},b._params=[],b.caseSensitive=a.caseSensitive,b.mergeParams=a.mergeParams,b.strict=a.strict,b.stack=[],b};proto.param=function(a,b){if("function"==typeof a)return deprecate("router.param(fn): Refactor to use path params"),void this._params.push(a);var c,d=this._params,e=d.length;":"===a[0]&&(deprecate("router.param("+JSON.stringify(a)+", fn): Use router.param("+JSON.stringify(a.substr(1))+", fn) instead"),a=a.substr(1));for(var f=0;e>f;++f)(c=d[f](a,b))&&(b=c);if("function"!=typeof b)throw new Error("invalid param() call for "+a+", got "+b);return(this.params[a]=this.params[a]||[]).push(b),this},proto.handle=function(a,b,c){function d(g){var h="route"===g?null:g;if(m&&(a.url=a.url.substr(1),m=!1),0!==l.length&&(a.baseUrl=r,a.url=j+l+a.url.substr(j.length),l=""),k>=p.length)return void setImmediate(c,h);var i=getPathname(a);if(null==i)return c(h);for(var s,t,u;t!==!0&&k<p.length;)if(s=p[k++],t=matchLayer(s,i),u=s.route,"boolean"!=typeof t&&(h=h||t),t===!0&&u)if(h)t=!1;else{var v=a.method,w=u._handles_method(v);w||"OPTIONS"!==v||appendMethods(o,u._options()),w||"HEAD"===v||(t=!1)}if(t!==!0)return c(h);u&&(a.route=u),a.params=f.mergeParams?mergeParams(s.params,q):s.params;var x=s.path;f.process_params(s,n,a,b,function(c){return c?d(h||c):u?s.handle_request(a,b,d):void e(s,h,x,i)})}function e(c,e,f,g){var h=g[f.length];return h&&"/"!==h&&"."!==h?d(e):(0!==f.length&&(debug("trim prefix (%s) from url %s",f,a.url),l=f,a.url=j+a.url.substr(j.length+l.length),i||"/"===a.url[0]||(a.url="/"+a.url,m=!0),a.baseUrl=r+("/"===l[l.length-1]?l.substring(0,l.length-1):l)),debug("%s %s : %s",c.name,f,a.originalUrl),void(e?c.handle_error(e,a,b,d):c.handle_request(a,b,d)))}var f=this;debug("dispatching %s %s",a.method,a.url);var g=1+a.url.indexOf("?"),h=g?g-1:a.url.length,i="/"!==a.url[0]&&1+a.url.substr(0,h).indexOf("://"),j=i?a.url.substr(0,a.url.indexOf("/",2+i)):"",k=0,l="",m=!1,n={},o=[],p=f.stack,q=a.params,r=a.baseUrl||"";c=restore(c,a,"baseUrl","next","params"),a.next=d,"OPTIONS"===a.method&&(c=wrap(c,function(a,c){return c||0===o.length?a(c):void sendOptionsResponse(b,o,a)})),a.baseUrl=r,a.originalUrl=a.originalUrl||a.url,d()},proto.process_params=function(a,b,c,d,e){function f(a){return a?e(a):o>=i.length?e():(p=0,(k=i[o++])?(j=k.name,l=c.params[j],m=h[j],n=b[j],void 0!==l&&m?n&&(n.error||n.match===l)?(c.params[j]=n.value,f(n.error)):(b[j]=n={error:null,match:l,value:l},void g()):f()):e())}function g(a){var b=m[p++];if(n.value=c.params[k.name],a)return n.error=a,void f(a);if(!b)return f();try{b(c,d,g,l,k.name)}catch(e){g(e)}}var h=this.params,i=a.keys;if(!i||0===i.length)return e();var j,k,l,m,n,o=0,p=0;f()},proto.use=function(a){var b=0,c="/";if("function"!=typeof a){for(var d=a;Array.isArray(d)&&0!==d.length;)d=d[0];"function"!=typeof d&&(b=1,c=a)}var e=utils.flatten(slice.call(arguments,b));if(0===e.length)throw new TypeError("Router.use() requires middleware functions");return e.forEach(function(a){if("function"!=typeof a)throw new TypeError("Router.use() requires middleware function but got a "+gettype(a));debug("use %s %s",c,a.name||"<anonymous>");var b=new Layer(c,{sensitive:this.caseSensitive,strict:!1,end:!1},a);b.route=void 0,this.stack.push(b)},this),this},proto.route=function(a){var b=new Route(a),c=new Layer(a,{sensitive:this.caseSensitive,strict:this.strict,end:!0},b.dispatch.bind(b));return c.route=b,this.stack.push(c),b},methods.concat("all").forEach(function(a){proto[a]=function(b){var c=this.route(b);return c[a].apply(c,slice.call(arguments,1)),this}});