function finalhandler(a,b,c){c=c||{};var d=c.env||process.env.NODE_ENV||"development",e=c.onerror;return function(c){var f;if(!c&&b._header)return void debug("cannot 404 after headers sent");if(c){(!b.statusCode||b.statusCode<400)&&(b.statusCode=500),c.status&&(b.statusCode=c.status);var f="production"===d?http.STATUS_CODES[b.statusCode]:c.stack||c.toString();f=escapeHtml(f).replace(/\n/g,"<br>").replace(/  /g," &nbsp;")+"\n"}else b.statusCode=404,f="Cannot "+escapeHtml(a.method)+" "+escapeHtml(a.originalUrl||a.url)+"\n";return debug("default %s",b.statusCode),c&&e&&defer(e,c,a,b),b._header?a.socket.destroy():void send(a,b,b.statusCode,f)}}function send(a,b,c,d){function e(){return b.statusCode=c,b.setHeader("X-Content-Type-Options","nosniff"),b.setHeader("Content-Type","text/html; charset=utf-8"),b.setHeader("Content-Length",Buffer.byteLength(d,"utf8")),"HEAD"===a.method?void b.end():void b.end(d,"utf8")}return isFinished(a)?void e():(unpipe(a),onFinished(a,e),void a.resume())}function unpipe(a){if("function"==typeof a.unpipe)return void a.unpipe();for(var b,c=a.listeners("close"),d=0;d<c.length;d++)b=c[d],("cleanup"===b.name||"onclose"===b.name)&&b.call(a)}var debug=require("debug")("finalhandler"),escapeHtml=require("escape-html"),http=require("http"),onFinished=require("on-finished"),defer="function"==typeof setImmediate?setImmediate:function(a){process.nextTick(a.bind.apply(a,arguments))},isFinished=onFinished.isFinished;module.exports=finalhandler;