function onFinished(a,b){return isFinished(a)!==!1?(defer(b,null,a),a):(attachListener(a,b),a)}function isFinished(a){var b=a.socket;return"boolean"==typeof a.finished?Boolean(a.finished||b&&!b.writable):"boolean"==typeof a.complete?Boolean(!b||!b.readable||a.complete&&!a.readable):void 0}function attachFinishedListener(a,b){function c(a){e.cancel(),f.cancel(),g=!0,b(a)}function d(b){a.removeListener("socket",d),g||e===f&&(f=first([[b,"error","close"]],c))}var e,f,g=!1;return e=f=first([[a,"end","finish"]],c),a.socket?void d(a.socket):(a.on("socket",d),void(void 0===a.socket&&patchAssignSocket(a,d)))}function attachListener(a,b){var c=a.__onFinished;c&&c.queue||(c=a.__onFinished=createListener(a),attachFinishedListener(a,c)),c.queue.push(b)}function createListener(a){function b(c){if(a.__onFinished===b&&(a.__onFinished=null),b.queue){var d=b.queue;b.queue=null;for(var e=0;e<d.length;e++)d[e](c,a)}}return b.queue=[],b}function patchAssignSocket(a,b){var c=a.assignSocket;"function"==typeof c&&(a.assignSocket=function(a){c.call(this,a),b(a)})}module.exports=onFinished,module.exports.isFinished=isFinished;var first=require("ee-first"),defer="function"==typeof setImmediate?setImmediate:function(a){process.nextTick(a.bind.apply(a,arguments))};