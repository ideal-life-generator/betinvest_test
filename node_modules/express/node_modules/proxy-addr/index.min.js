function alladdrs(a,b){var c=forwarded(a);if(!b)return c;"function"!=typeof b&&(b=compile(b));for(var d=0;d<c.length-1;d++)b(c[d],d)||(c.length=d+1);return c}function compile(a){if(!a)throw new TypeError("argument is required");var b="string"==typeof a?[a]:a;if(!Array.isArray(b))throw new TypeError("unsupported trust argument");for(var c=0;c<b.length;c++)a=b[c],ipranges.hasOwnProperty(a)&&(a=ipranges[a],b.splice.apply(b,[c,1].concat(a)),c+=a.length-1);return compileTrust(compileRangeSubnets(b))}function compileRangeSubnets(a){for(var b=new Array(a.length),c=0;c<a.length;c++)b[c]=parseipNotation(a[c]);return b}function compileTrust(a){var b=a.length;return 0===b?trustNone:1===b?trustSingle(a[0]):trustMulti(a)}function parseipNotation(a){var b,c,d,e,f=a.lastIndexOf("/");if(b=-1!==f?a.substring(0,f):a,!isip(b))throw new TypeError("invalid IP address: "+b);if(b=parseip(b),c=b.kind(),d="ipv6"===c?128:32,e=-1!==f?a.substring(f+1,a.length):d,"number"!=typeof e&&(e=digitre.test(e)?parseInt(e,10):isip(e)?parseNetmask(e):0),"ipv6"===b.kind()&&b.isIPv4MappedAddress()&&(b=b.toIPv4Address(),e=d>=e?e-96:e),0>=e||e>d)throw new TypeError("invalid range on address: "+a);return[b,e]}function parseNetmask(a){var b,c,d=parseip(a);switch(d.kind()){case"ipv4":b=d.octets,c=8;break;case"ipv6":b=d.parts,c=16}for(var e,f=Math.pow(2,c)-1,g=0,h=0;h<b.length;h++){e=b[h]&f;{if(e!==f){for(;e;)e=e<<1&f,g+=1;break}g+=c}}return g}function proxyaddr(a,b){if(!a)throw new TypeError("req argument is required");if(!b)throw new TypeError("trust argument is required");var c=alladdrs(a,b),d=c[c.length-1];return d}function trustNone(){return!1}function trustMulti(a){return function(b){if(!isip(b))return!1;for(var c,d,e,f,g,h,i=parseip(b),j=i.kind(),k=0;k<a.length;k++){if(d=a[k],e=d[0],f=e.kind(),g=d[1],h=i,j!==f){if("ipv6"!==j||"ipv4"!==f||!i.isIPv4MappedAddress())continue;c=c||i.toIPv4Address(),h=c}if(h.match(e,g))return!0}return!1}}function trustSingle(a){var b=a[0],c=b.kind(),d="ipv4"===c,e=a[1];return function(a){if(!isip(a))return!1;var f=parseip(a),g=f.kind();return g===c?f.match(b,e):d&&"ipv6"===g&&f.isIPv4MappedAddress()?f.toIPv4Address().match(b,e):!1}}module.exports=proxyaddr,module.exports.all=alladdrs,module.exports.compile=compile;var forwarded=require("forwarded"),ipaddr=require("ipaddr.js"),digitre=/^[0-9]+$/,isip=ipaddr.isValid,parseip=ipaddr.parse,ipranges={linklocal:["169.254.0.0/16","fe80::/10"],loopback:["127.0.0.1/8","::1/128"],uniquelocal:["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","fc00::/7"]};